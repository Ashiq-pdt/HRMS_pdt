<!-- templates/admin/index.html -->
{% extends "layout/base.html" %}
{% block head %}
{{ super() }}
<style>
    table.dataTable tbody th,
    table.dataTable tbody td,
    table.dataTable thead th,
    table.dataTable thead td {
        padding: 5px 10px !important;
    }
</style>

{% endblock %}

{% block content %}
<!--Page header-->
<div class="page-header d-xl-flex d-block">
    <div class="page-leftheader">
        <div class="page-title">Attendance</div>
    </div>
    <div class="page-rightheader ms-md-auto">
        <div class="d-flex align-items-end flex-wrap my-auto end-content breadcrumb-end">
            <div class="btn-list">
                <button class="btn btn-primary" data-bs-placement="top" data-bs-toggle="modal"
                    data-bs-target="#largemodal" id="queue-status"> <i class="feather fe fe-upload-cloud"> </i> Queue
                    Status </button>
                <!-- <button  class="btn btn-light" data-bs-toggle="tooltip" data-bs-placement="top" title="E-mail"> <i class="feather feather-mail"></i> </button>
                <button  class="btn btn-light" data-bs-placement="top" data-bs-toggle="tooltip" title="Contact"> <i class="feather feather-phone-call"></i> </button>
                <button  class="btn btn-primary" data-bs-placement="top" data-bs-toggle="tooltip" title="Info"> <i class="feather feather-info"></i> </button> -->
            </div>
        </div>
    </div>
</div>
<!--End Page header-->

<div class="row">
    <div class="col-xl-12 col-md-12 col-lg-12">
        <div class="card">
            <div class="card-body">
                <form class="card-body pt-3" method="POST" action="/attendance">
                    <input type="hidden" name="csrf_token" id="csrf_gen" value="{{ csrf_token() }}" />
                    <div class="row mt-5">
                        <!-- <div class="col-md-6 col-lg-3">
                        <div class="form-group">
                            <label class="form-label">Employee Name:</label>
                            <select class="form-control custom-select select2" data-placeholder="Select Employee">
                                <option label="Select Employee"></option>
                                <option value="1">Faith Harris</option>
                                <option value="2">Austin Bell</option>
                                <option value="3">Maria Bower</option>
                                <option value="4">Peter Hill</option>
                                <option value="5">Victoria Lyman</option>
                                <option value="6">Adam Quinn</option>
                                <option value="7">Melanie Coleman</option>
                                <option value="8">Max Wilson</option>
                                <option value="9">Amelia Russell</option>
                                <option value="10">Justin Metcalfe</option>
                                <option value="11">Ryan Young</option>
                                <option value="12">Jennifer Hardacre</option>
                                <option value="13">Justin Parr</option>
                                <option value="14">Julia Hodges</option>
                                <option value="15">Michael Sutherland</option>
                            </select>
                        </div>
                    </div> -->
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label">Attendance Month:</label>
                            <input class="form-control" placeholder="Month Range" type="text" name="selected_month"
                                id="selected_month" value="{{start_of_month.strftime('%Y-%m-%d')}}" hidden>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <div class="input-group-text">
                                        <span class="feather feather-clock"></span>
                                    </div>
                                </div>

                                <input class="form-control" id="filter-datepicker-month" placeholder="Month Range"
                                    type="text" name="month_range_input" value="{{start_of_month.strftime('%B')}}">
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-2">
                            <div class="form-group mt-5">
                                <button href="javascript:void(0);" class="btn btn-primary btn-block">Search</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="card-body">
                <div class="d-flex mb-6 mt-5">
                    <div>
                        <span class="badge badge-success-light me-2"><i
                                class="feather feather-check-circle text-success"></i> Present</span>
                        <span class="badge badge-danger-light me-2"><i class="feather feather-x-circle text-danger"></i>
                            Absent</span>
                        <span class="badge badge-warning-light me-2"><i class="fa fa-star text-warning"></i>
                            Holiday</span>
                        <span class="badge badge-default me-2"><i class="fe fe-x-square text-grey"></i> Day/Week
                            off</span>
                        <span class="badge badge-orange-light me-2"><i
                                class="feather feather-check-circle text-orange"></i> Late</span>
                        <span class="badge badge-info-light me-2"><i class="feather feather-minus text-blue"></i> No
                            Attendance</span>
                    </div>
                </div>
                <div class="table-responsive hr-attlist">
                    <table class="table  table-vcenter text-nowrap table-bordered border-bottom" id="hr-attendance">
                        <thead>
                            <tr>
                                <th class="border-bottom-0">Employee Name</th>
                                <th class="border-bottom-0">Action</th>
                                <th class="border-bottom-0 text-center" data-bs-toggle="tooltip" data-bs-placement="top"
                                    title="(Present/Absent/Holiday/Dayoff/Late)/ Total No of Days">Total</th>
                                {% for current_date in range(no_of_days) %}
                                <th class="border-bottom-0 w-5">{{current_date+1}}</th>
                                {% endfor %}
                            </tr>
                        </thead>

                        <tbody>
                            {% for item in emp_attendance_data %}
                            <tr>
                                <td>
                                    <div class="d-flex">
                                        <div class="me-3 mt-0 mt-sm-2 d-block">
                                            <h6 class="mb-1 fs-14">
                                                {{item.emp_data.first_name +' '+ item.emp_data.last_name}}</h6>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <button href="javascript:void(0);" class="action-btns" 
                                        id="btnPayslip" id="payslip" data-employee_id="{{item.emp_data.id}}"
                                        data-selected_year="{{start_of_month}}"
                                        data-selected_month="{{start_of_month}}">
                                        <i class="fe fe-layers text-primary" data-bs-toggle="tooltip"
                                            data-bs-placement="top" title="View Payroll Details"></i>
                                    </button>
                                </td>
                                <td>
                                    <h6 class="mb-0">
                                        <span data-bs-toggle="tooltip" data-bs-placement="top"
                                            title="No of Days Present"
                                            class="text-success">({{item.attendance_data | selectattr('attendance_status', 'equalto', 'present')|list|length}}</span>
                                        <span class="my-auto fs-8 font-weight-normal text-muted">/</span>
                                        <span data-bs-toggle="tooltip" data-bs-placement="top" title="No of Days Absent"
                                            class="text-danger">{{item.attendance_data | selectattr('attendance_status', 'equalto', 'absent')|list|length}}</span>
                                        <span class="my-auto fs-8 font-weight-normal text-muted">/</span>
                                        <span data-bs-toggle="tooltip" data-bs-placement="top" title="No of Holidays"
                                            class="text-warning">{{item.attendance_data | selectattr('attendance_status', 'equalto', 'holiday')|list|length}}</span>
                                        <span class="my-auto fs-8 font-weight-normal text-muted">/</span>
                                        <span data-bs-toggle="tooltip" data-bs-placement="top" title="No of Dayoffs"
                                            class="text-grey">{{item.attendance_data | selectattr('attendance_status', 'equalto', 'dayoff')|list|length}}</span>
                                        <span class="my-auto fs-8 font-weight-normal text-muted">/</span>
                                        <span data-bs-toggle="tooltip" data-bs-placement="top" title="No of Days Late"
                                            class="text-orange">{{item.attendance_data | selectattr('late_by_minutes')|list|length}})</span>
                                        <span class="my-auto fs-8 font-weight-normal text-muted">/</span>
                                        <span data-bs-toggle="tooltip" data-bs-placement="top" title="Total No of Days"
                                            class="">{{no_of_days}}</span>
                                    </h6>
                                </td>
                                {% if item.attendance_data %}
                                    {% for attendance_item in item.attendance_data %}
                                        {% if attendance_item.attendance_status == 'present' %}
                                        <!-- Present -->
                                        <td>
                                            <div class="hr-listd">
                                                <!-- <a  href="javascript:void(0);" data-bs-toggle="modal" data-bs-target="#presentmodal" class="hr-listmodal"></a> -->
                                                <span
                                                    class="feather feather-check-circle {{'text-orange' if (attendance_item.late_by_minutes|default(0)|int) > 0 else 'text-success' }}"
                                                    data-bs-toggle="tooltip" data-bs-placement="top"
                                                    title=" {{('Late By : ' + attendance_item.late_by_minutes +' minutes'  if (attendance_item.late_by_minutes|default(0)|int) > 0 else 'Ontime')}} , {{'Overtime By : ' + attendance_item.ot_by_minutes +' minutes'  if attendance_item.has_overtime else 'No Overtime'  }} "></span>
                                            </div>
                                        </td>
                                        {% elif attendance_item.attendance_status == 'dayoff' %}
                                        <!-- DayOff/Weekoff -->
                                        <td>
                                            <div class="hr-listd">
                                                <span data-bs-toggle="tooltip" data-bs-placement="top" title="Day/Week off"
                                                    class="fe fe-x-square text-grey"></span>
                                            </div>
                                        </td>
                                        {% elif attendance_item.attendance_status == 'absent' %}
                                        <!-- Absent -->
                                        <td><span data-bs-toggle="tooltip" data-bs-placement="top" title="Absent"
                                                class="feather feather-x-circle text-danger "></span></td>
                                        {% elif attendance_item.attendance_status == 'holiday' %}
                                        <!-- Holidays -->
                                        <td><span class="fa fa-star text-warning" data-bs-toggle="tooltip"
                                                data-bs-placement="top" title="{{attendance_item.occasion_for}}"></span></td>
                                        {% else %}
                                        <td><span class="fe fe-minus text-blue"></span></td>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="largemodal" tabindex="-1" role="dialog" aria-labelledby="largemodal" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="largemodal1">Queue Status</h5>
                <button class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card-header  border-0">
                    <h3>Queue Status</h3>
                </div>
                <div class="card">
                    <div class="card-body pt-0">
                        <p>Queue task will take time depending upon the file size and number of active employees. If in
                            case there is an error you can retry anytime.</p>
                        <div class="row">
                            <div class="col-xl-12 col-md-12 col-lg-12">
                                <div class="card" style="max-height:50vh;overflow:scroll">
                                    <div class="card-body pt-1">
                                        <div class="table-responsive">
                                            <table class="table  table-vcenter text-nowrap table-bordered border-bottom"
                                                id="queue-table">
                                                <thead>
                                                    <tr>
                                                        <th class="border-bottom-0 w-5">File Name
                                                        </th>
                                                        <th class="border-bottom-0">Uploaded On
                                                        </th>
                                                        <th class="border-bottom-0">Status
                                                    </tr>
                                                </thead>
                                                <tbody>

                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!--Payslip Modal -->
<div class="modal fade" id="viewsalarymodal">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">PaySlip</h5>
                <button class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-header">
                <div>
                    <img src="{{ url_for('static', filename='assets/images/brand/pdt-logo.png') }}" class="header-brand-img w-60"
                        alt="Dayonelogo">
                </div>
                <div class="ms-auto">
                    <div class="font-weight-bold text-md-right mt-3 ">Date: <span
                            class="paytable_current_date">01-02-2021</span> </div>
                </div>
            </div>
            <div class="modal-body pt-1">
                <div class="table-responsive mt-3 mb-3">
                    <table class="table mb-0 modal-paytable paytable-emp-details">
                        <tbody>

                        </tbody>
                    </table>
                </div>
                <div class="table-responsive mt-4">
                    <table class="table text-nowrap mb-0 border">
                        <tbody>
                            <tr>
                                <td class="p-0">
                                    <table class="table text-nowrap mb-0 border-start paytable-actual-pay">
                                        <thead>
                                            <tr>
                                                <th class="fs-18" rowspan="1" colspan="2">Earnings</th>
                                            </tr>
                                            <tr>
                                                <th>Pay Type</th>
                                                <th class="border-start">Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody>

                                        </tbody>
                                    </table>
                                </td>
                                <td class="p-0">
                                    <table class="table text-nowrap mb-0 border-start paytable-deduction-pay">
                                        <thead>
                                            <tr>
                                                <th class="fs-18" rowspan="1" colspan="2">Deduction</th>
                                            </tr>
                                            <tr>
                                                <th>Pay Type</th>
                                                <th class="border-start">Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody>

                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 mb-3">
                    <table class="table mb-0 pay-table-netsalary">
                        <tbody>
                            <tr>
                                <td class="font-weight-semibold w-20 fs-18 pb-0 pt-0">Net Salary</td>
                                <td class="pb-0 pt-0">
                                    <h4 class="font-weight-semibold mb-0 fs-24">$32,000</h4>
                                </td>
                            </tr>
                            <tr>
                                <td class="font-weight-semibold w-20 pb-0 pt-1 text-muted">InWords</td>
                                <td class="pb-0 pt-1">
                                    <h5 class="mb-0  text-muted">Thirty-Two Thousand only</h5>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- <div class="p-5 border-top text-center">
                <div class="text-center">
                    <h6 class="mb-2">Spruko Technologies Pvt Ltd.</h6>
                    <p class="mb-1 fs-12">Near Tulasi Hospital ECIL, ushaiguda, Hyderabad, Telangana 500062</p>
                    <div>
                        <small>Tel No: 99488 67536,</small>
                        <small>Email: info@spruko.com</small>
                    </div>
                </div>
            </div> -->
            <div class="modal-footer">
                <div class="ms-auto">
                    <!-- <a  href="javascript:void(0);" class="btn btn-info" onclick="javascript:window.print();"><i class="si si-printer"></i> Print</a>
                    <a  href="javascript:void(0);" class="btn btn-success"><i class="feather feather-download"></i> Download</a>
                    <a  href="javascript:void(0);" class="btn btn-primary"><i class="si si-paper-plane"></i> Send</a> -->
                    <a href="javascript:void(0);" class="btn btn-danger" data-bs-dismiss="modal"><i
                            class="feather feather-x"></i> Close</a>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- End Addexpense Modal  -->

<!-- Modal -->
{% endblock %}
{% block script %}
{{ super() }}

<!-- Datepicker js -->
<!-- <script src="{{ url_for('static', filename='assets/plugins/date-picker/jquery-ui.js') }}"></script> -->
<!-- INTERNAL Bootstrap-Datepicker js-->
<script src="{{ url_for('static', filename='assets/plugins/bootstrap-datepicker/bootstrap-datepicker.js') }}"></script>
<script>
    // payslip
    // Year picker
    fpy = $('#datepicker-year').bootstrapdatepicker({
        format: "yyyy",
        viewMode: "year",
        minViewMode: "years",
        orientation: 'bottom',
        multidate: false,
        multidateSeparator: "-",
    })
    fpm = $('#filter-datepicker-month').bootstrapdatepicker({
        format: "MM",
        endDate: '+0m',
        viewMode: "months",
        minViewMode: "months",
        orientation: 'bottom',
        multidate: false,
        multidateSeparator: "-",
        autoclose: true
    })
    //fpy.on('changeDate', function (e) {
    //  $('.action-btns').attr("data-selected_year", e.dates)
    //});
    fpm.on('changeDate', function (e) {
        $('.action-btns').attr("data-selected_month", e.dates)
        $('#selected_month').val(moment(new Date(e.dates)).format('YYYY-MM-DD'))
    });
    $(document).ready(function () {
        $('#queue-status').click(function () {
            // AJAX request
            $("#global-loader").show();
            $.ajax({
                url: '/queuestatus',
                type: 'get',
                success: function (response) {
                    // Add response in Modal body
                    if (response.status == "success") {
                        var data = '';
                        $.each(response.details, function (index, value) {
                            data += '<tr>';
                            data += '<td>' + value.file_name + '</td>';
                            data += '<td>' + value.uploaded_on + '</td>';
                            if (value.status == "SUCCESS") {
                                data +=
                                    '<td><span class="badge badge-success-light">Success</span></td>';
                            } else if (value.status == "STARTED") {
                                data +=
                                    '<td><span class="badge badge-warning-light">Pending</span></td>';
                            } else {
                                data +=
                                    '<td><span class="badge badge-danger-light">Failed</span></td>';
                            }
                            data += '<tr>';
                        });
                        //$('.modal-body').html(response);
                        $('#queue-table tbody').html(data);
                        $("#global-loader").hide();
                    } 
                    else {
                        $('#queue-table').html(
                            ' Nothing Uploaded as of now, Queue is empty! ');
                        //$('#largemodal').modal('toggle');
                        $("#global-loader").hide();
                    }
                    // Display Modal
                    $('#largemodal').modal('show');
                }
            });
        });

          // Pay Slip Start
        // $(document).on("click", '#btnPayslip', function (e) {
        //     // AJAX request
        //     e.preventDefault();
        //     $('#viewsalarymodal').modal('hide');

        //     var selected_month = $(this).attr("data-selected_month")
        //     //var selected_year = $(this).attr("data-selected_year")
        //     var employee_id = $(this).attr("data-employee_id")
        //     if (selected_month) {
        //         selected_month = moment(new Date(selected_month)).format('YYYY-MM-DD')
        //     }
        //     //if(selected_year){
        //     //  selected_year =  moment(new Date(selected_year)).format('YYYY-MM-DD')
        //     //}
        //     $.ajax({
        //         url: '/payslipdetails',
        //         data: {
        //             'selected_month': selected_month,
        //             //'selected_year': selected_year, 
        //             'employee_id': employee_id
        //         },
        //         type: 'GET',
        //         success: function (response) {
        //             // Add response in Modal body
        //             data = JSON.parse(response)
        //             if (data.status == "success") {
        //                 details = '<tr>\
        //                         <td>\
        //                             <strong>Emp ID:</strong>\
        //                             <span>' + data.employee_details.employee_company_details.employee_id + '</span>\
        //                         </td>\
        //                         <td class="text-end">\
        //                             <strong>Pay Period:</strong>\
        //                             <span>' + moment(new Date(selected_month)).format('MMMM') + ' ' + moment(new Date(
        //                         selected_month)).format('YYYY') + '</span>\
        //                         </td>\
        //                     </tr>\
        //                     <tr>\
        //                         <td>\
        //                             <strong>Emp Name:</strong>\
        //                             <span>' + data.employee_details.first_name + ' ' + data.employee_details
        //                     .last_name + '</span>\
        //                         </td>\
        //                         <td class="text-end">\
        //                             <strong>Deignation:</strong>\
        //                             <span>' + data.employee_details.employee_company_details.designation + '</span>\
        //                         </td>\
        //                     </tr>'
        //                 $('.paytable-emp-details tbody').empty();
        //                 $('.paytable-emp-details tbody').html(details);
        //                 const timeElapsed = Date.now();
        //                 const today = new Date(timeElapsed);
        //                 $('.paytable_current_date').html(today.toDateString());
        //                 $('.paytable-actual-pay tbody').empty();
        //                 $('.paytable-deduction-pay tbody').empty();
        //                 $('.pay-table-netsalary tbody').empty();


        //                 actual_pay_details = '<tr>\
        //                         <td>Basic Pay</td>\
        //                         <td class="border-start">' + (data.gross_pay - data.ot_amount + data
        //                         .late_deduction_amount + data.early_deduction_amount)
        //                     .toFixed(2) + '</td>\
        //                     </tr>\
        //                     <tr>\
        //                         <td>Approved Overtime Pay</td>\
        //                         <td class="border-start">' + (data.ot_amount).toFixed(2) + '</td>\
        //                     </tr>\
        //                     <tr class="border-top">\
        //                         <td class="font-weight-semibold">Total Pay (w/o deductions)</td>\
        //                         <td class="font-weight-semibold border-start">AED ' + (data.gross_pay - data
        //                         .ot_amount + data.late_deduction_amount + data
        //                         .early_deduction_amount + data.ot_amount).toFixed(2) + '</td>\
        //                     </tr>'

        //                 deduction_details = '<tr>\
        //                         <td>Late Arrival</td>\
        //                         <td class="border-start">' + (data.late_deduction_amount).toFixed(2) + '</td>\
        //                     </tr>\
        //                     <tr>\
        //                         <td>Early Departure</td>\
        //                         <td class="border-start">' + (data.early_deduction_amount).toFixed(2) + '</td>\
        //                     </tr>\
        //                     <tr class="border-top">\
        //                         <td class="font-weight-semibold">Total Deduction</td>\
        //                         <td class="font-weight-semibold border-start">' + (data.late_deduction_amount + data
        //                     .early_deduction_amount).toFixed(2) + '</td>\
        //                     </tr>'
        //                 $('.paytable-actual-pay tbody').html(actual_pay_details);
        //                 $('.paytable-deduction-pay tbody').html(deduction_details);

        //                 net_salary_details = '<tr>\
        //                     <td class="font-weight-semibold w-20 fs-18 pb-0 pt-0">Net Salary</td>\
        //                     <td class="pb-0 pt-0">\
        //                         <h4 class="font-weight-semibold mb-0 fs-24">AED: ' + (data.gross_pay).toFixed(2) + '</h4>\
        //                     </td>\
        //                 </tr>\
        //                 <tr>\
        //                     <td class="font-weight-semibold w-20 pb-0 pt-1 text-muted">InWords</td>\
        //                     <td class="pb-0 pt-1">\
        //                         <h5 class="mb-0  text-muted">' + numberToWords((data.gross_pay).toFixed(2)) + '</h5>\
        //                     </td>\
        //                 </tr>'
        //                 $('.pay-table-netsalary tbody').html(net_salary_details);

        //                 // Display Modal
        //                 $('#viewsalarymodal').modal('toggle');
        //             } else {
        //                 data = JSON.parse(response)

        //                 details = '<tr>\
        //                     <td>\
        //                         <strong>Emp ID:</strong>\
        //                         <span>' + data.employee_details.employee_company_details.employee_id + '</span>\
        //                     </td>\
        //                     <td class="text-end">\
        //                         <strong>Pay Period:</strong>\
        //                         <span>' + moment(new Date(selected_month)).format('MMMM') + ' ' + moment(new Date(
        //                     selected_month)).format('YYYY') + '</span>\
        //                     </td>\
        //                 </tr>\
        //                 <tr>\
        //                     <td>\
        //                         <strong>Emp Name:</strong>\
        //                         <span>' + data.employee_details.first_name + ' ' + data.employee_details.last_name + '</span>\
        //                     </td>\
        //                     <td class="text-end">\
        //                         <strong>Deignation:</strong>\
        //                         <span>' + data.employee_details.employee_company_details.designation + '</span>\
        //                     </td>\
        //                 </tr>'
        //                 $('.paytable-emp-details tbody').empty();
        //                 $('.paytable-emp-details tbody').html(details);
        //                 $('#viewsalarymodal').modal('toggle');
        //                 const timeElapsed = Date.now();
        //                 const today = new Date(timeElapsed);
        //                 $('.paytable_current_date').html(today.toDateString());
        //                 $('.paytable-actual-pay tbody').empty();
        //                 $('.paytable-deduction-pay tbody').empty();
        //                 $('.pay-table-netsalary tbody').empty();
        //                 $('.pay-table-netsalary tbody').html(
        //                     'No Payroll Data Found for this month! Please check whether you have selected the desired Month and Year!'
        //                     );
        //             }
        //         }
        //     });
        // });
        // Pay Slip End 

        // New Pay Slip Start
        $(document).on("click", '#btnPayslip', function (e) {
            // AJAX request
            e.preventDefault();
            //$('#viewsalarymodal').modal('hide');

            var selected_month = $(this).attr("data-selected_month")
            //var selected_year = $(this).attr("data-selected_year")
            var employee_id = $(this).attr("data-employee_id")
            if (selected_month) {
                selected_month = moment(new Date(selected_month)).format('YYYY-MM-DD')
            }
            $.ajax({
                url: '/payrollinfo',
                data: {
                    'selected_month': selected_month,
                    'employee_id': employee_id
                },
                type: 'GET',
                success: function (response) {
                    // Add response in Modal body
                    data = JSON.parse(response)
                    if (data.status == "success") {
                        details = '<tr>\
                                <td>\
                                    <strong>Emp ID:</strong>\
                                    <span>' + data.employee_details.employee_company_details.employee_id + '</span>\
                                </td>\
                                <td class="text-end">\
                                    <strong>Pay Period:</strong>\
                                    <span>' + moment(new Date(selected_month)).format('MMMM') + ' ' + moment(new Date(
                                selected_month)).format('YYYY') + '</span>\
                                </td>\
                            </tr>\
                            <tr>\
                                <td>\
                                    <strong>Emp Name:</strong>\
                                    <span>' + data.employee_details.first_name + ' ' + data.employee_details
                            .last_name + '</span>\
                                </td>\
                                <td class="text-end">\
                                    <strong>Deignation:</strong>\
                                    <span>' + data.employee_details.employee_company_details.designation + '</span>\
                                </td>\
                            </tr>'
                        
                        // Check the no of rows in both addition and deduction and add total no of rows to each to make it even
                        let additions_row = 1
                        let deduction_row = 0
                    
                        $('.paytable-emp-details tbody').empty();
                        $('.paytable-emp-details tbody').html(details);
                        const timeElapsed = Date.now();
                        const today = new Date(timeElapsed);
                        $('.paytable_current_date').html(today.toDateString());
                        $('.paytable-actual-pay tbody').empty();
                        $('.paytable-deduction-pay tbody').empty();
                        $('.pay-table-netsalary tbody').empty();
                        
                        actual_pay_details = ''
                        actual_pay_details +=
                        '<tr>\
                            <td>Monthly Gross Salary</td>\
                            <td class="border-start">' + data.payroll_data.total_salary + '</td>\
                        </tr>';

                        $.each(data.payroll_data.adjustment_additions, function (index, value) {
                            additions_row++;
                            actual_pay_details +=
                                '<tr>\
                                    <td>'+ value.reason +'</td>\
                                    <td class="border-start">' + value.amount + '</td>\
                                </tr>';
                        });
                        

                        deduction_details = ''
                        $.each(data.payroll_data.adjustment_deductions, function (index, value) {
                            deduction_row++;
                            deduction_details +=
                                '<tr>\
                                    <td>'+ value.reason +'</td>\
                                    <td class="border-start">' + value.amount + '</td>\
                                </tr>';
                        });
                        // Check the no of rows in both addition and deduction and add total no of rows to each to make it even
                        if (additions_row>deduction_row){
                            no_of_extra_rows = additions_row - deduction_row;
                            for (let i = 0; i < no_of_extra_rows; i++) {
                                deduction_details +='<tr><td class="border-start">&nbsp;</td><td class="border-start">&nbsp;</td></tr>';
                              }
                        }
                        if (deduction_row>additions_row){
                            no_of_extra_rows = deduction_row-additions_row;
                            for (let i = 0; i < no_of_extra_rows; i++) {
                                actual_pay_details +='<tr><td class="border-start">&nbsp;</td><td class="border-start">&nbsp;</td></tr>';
                              }
                        }
                        // Total of additiona and deduction 
                        actual_pay_details += '<tr class="border-top">\
                            <td class="font-weight-semibold">Total Pay (w/o deductions)</td>\
                            <td class="font-weight-semibold border-start">AED ' + (data.payroll_data.total_salary + data.additions).toFixed(2) + '</td>\
                        </tr>';
                        deduction_details +=
                        '<tr class="border-top">\
                            <td class="font-weight-semibold">Total Deduction</td>\
                            <td class="font-weight-semibold border-start">AED ' + (data.deductions).toFixed(2) + '</td>\
                        </tr>';
                        $('.paytable-actual-pay tbody').html(actual_pay_details);
                        $('.paytable-deduction-pay tbody').html(deduction_details);

                        net_salary_details = '<tr>\
                            <td class="font-weight-semibold w-20 fs-18 pb-0 pt-0">Net Salary</td>\
                            <td class="pb-0 pt-0">\
                                <h4 class="font-weight-semibold mb-0 fs-24">AED: ' + (data.gross_pay).toFixed(2) + '</h4>\
                            </td>\
                        </tr>\
                        <tr>\
                            <td class="font-weight-semibold w-20 pb-0 pt-1 text-muted">InWords</td>\
                            <td class="pb-0 pt-1">\
                                <h5 class="mb-0  text-muted">' + numberToWords((data.gross_pay).toFixed(2)) + '</h5>\
                            </td>\
                        </tr>'
                        $('.pay-table-netsalary tbody').html(net_salary_details);

                        // Display Modal
                        $('#viewsalarymodal').modal('toggle');
                    } else {
                        data = JSON.parse(response)

                        details = '<tr>\
                            <td>\
                                <strong>Emp ID:</strong>\
                                <span>' + data.employee_details.employee_company_details.employee_id + '</span>\
                            </td>\
                            <td class="text-end">\
                                <strong>Pay Period:</strong>\
                                <span>' + moment(new Date(selected_month)).format('MMMM') + ' ' + moment(new Date(
                            selected_month)).format('YYYY') + '</span>\
                            </td>\
                        </tr>\
                        <tr>\
                            <td>\
                                <strong>Emp Name:</strong>\
                                <span>' + data.employee_details.first_name + ' ' + data.employee_details.last_name + '</span>\
                            </td>\
                            <td class="text-end">\
                                <strong>Deignation:</strong>\
                                <span>' + data.employee_details.employee_company_details.designation + '</span>\
                            </td>\
                        </tr>'
                        $('.paytable-emp-details tbody').empty();
                        $('.paytable-emp-details tbody').html(details);
                        $('#viewsalarymodal').modal('toggle');
                        const timeElapsed = Date.now();
                        const today = new Date(timeElapsed);
                        $('.paytable_current_date').html(today.toDateString());
                        $('.paytable-actual-pay tbody').empty();
                        $('.paytable-deduction-pay tbody').empty();
                        $('.pay-table-netsalary tbody').empty();
                        $('.pay-table-netsalary tbody').html(
                            'No Payroll Data Found for this month! Please check whether you have selected the desired Month and Year!'
                            );
                    }
                }
            });
        });
        // Pay Slip End

    });

    function numberToWords(number) {
        var digit = ['zero', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
        var elevenSeries = ['ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen',
            'eighteen', 'nineteen'
        ];
        var countingByTens = ['twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
        var shortScale = ['', 'thousand', 'million', 'billion', 'trillion'];

        number = number.toString();
        number = number.replace(/[\, ]/g, '');
        if (number != parseFloat(number)) return 'not a number';
        var x = number.indexOf('.');
        if (x == -1) x = number.length;
        if (x > 15) return 'too big';
        var n = number.split('');
        var str = '';
        var sk = 0;
        for (var i = 0; i < x; i++) {
            if ((x - i) % 3 == 2) {
                if (n[i] == '1') {
                    str += elevenSeries[Number(n[i + 1])] + ' ';
                    i++;
                    sk = 1;
                } else if (n[i] != 0) {
                    str += countingByTens[n[i] - 2] + ' ';
                    sk = 1;
                }
            } else if (n[i] != 0) {
                str += digit[n[i]] + ' ';
                if ((x - i) % 3 == 0) str += 'hundred ';
                sk = 1;
            }
            if ((x - i) % 3 == 1) {
                if (sk) str += shortScale[(x - i - 1) / 3] + ' ';
                sk = 0;
            }
        }
        if (x != number.length) {
            var y = number.length;
            str += 'point ';
            for (var i = x + 1; i < y; i++) str += digit[n[i]] + ' ';
        }
        str = str.replace(/\number+/g, ' ');
        return str.trim() + ".";
    }
</script>
<script>
    // Data Table 
    $('#hr-attendance').DataTable({
        "order": [
            [0, "desc"]
        ],
        ordering: false,
        language: {
            searchPlaceholder: 'Search...',
            sSearch: '',
        }
    });
</script>
{% endblock %}